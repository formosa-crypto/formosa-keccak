name: Benchmarks
permissions:
  contents: read
on:
  workflow_call:
  workflow_dispatch:

env:
  NIXPKGS_ALLOW_UNFREE: 1

jobs:
    test-permut:
      name: Test AVX2x4 Permutations
      runs-on: ubuntu-latest
      strategy:
        fail-fast: false
      steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive           
      - uses: cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            filter-syscalls = false
      - run: nix-shell --arg full false --run "make -C bench/test_avx2x4 run"
      - run: |
          echo "## AVX2x4 Permutation Test Output" >> $GITHUB_STEP_SUMMARY
          cat bench/test_avx2x4/bin/bench_permut.out >> $GITHUB_STEP_SUMMARY
    test-avx2x4:
      name: Test AVX2x4 Permutations
      runs-on: ubuntu-latest
      strategy:
        fail-fast: false
      steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive           
      - uses: cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            filter-syscalls = false
      - run: nix-shell --arg full false --run "make -C bench/compare_old/avx2 run"
      - run: |
          echo "## AVX2x4 Test Output" >> $GITHUB_STEP_SUMMARY
          cat bench/compare_old/avx2/bin/bench_avx2x4.out >> $GITHUB_STEP_SUMMARY
          echo "## AVX2x4 Old Test Output" >> $GITHUB_STEP_SUMMARY
          cat bench/compare_old/avx2/bin/bench_old_avx2x4.out >> $GITHUB_STEP_SUMMARY
    benchmark:
        name: Benchmarks
        runs-on: ubuntu-latest
        strategy:
          fail-fast: false
        steps:
        - uses: actions/checkout@v4
          with:
            submodules: recursive           
        - uses: cachix/install-nix-action@v31
          with:
            nix_path: nixpkgs=channel:nixos-unstable
            extra_nix_config: |
              filter-syscalls = false
        - run: nix-shell --arg full false --run "echo Dependencies OKâ€¦"
        - run: nix-shell --arg full false --run "make -C submodules/XKCP/ x86-64/libXKCP.so"
        - run: nix-shell --arg full false --run "make -C bench run"
        - run: |
            echo "## Benchmark Results" >> $GITHUB_STEP_SUMMARY
            for f in bench/bin/*.out; do
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### ${f}" >> $GITHUB_STEP_SUMMARY
              echo '| Sha3 Cycles | Shake Cyles | Shake4x Cycles|' >> $GITHUB_STEP_SUMMARY
              echo '| ----- | ----- | ----- |' >> $GITHUB_STEP_SUMMARY
              cat "$f" >> $GITHUB_STEP_SUMMARY
            done  