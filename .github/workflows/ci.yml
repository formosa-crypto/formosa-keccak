name: MLKEM implementation
permissions:
  contents: read
on:
  workflow_call:
  workflow_dispatch:

  
env:
  NIXPKGS_ALLOW_UNFREE: 1

jobs:
#     ct:
#       name: Check Constant-Time Security
#       permissions:
#         contents: read
#         id-token: write
#       uses: ./.github/workflows/ct.yml
#       secrets: inherit 
    compile_and_test:
        name: Compile and Test Keccak implementation
        runs-on: ubuntu-latest
        strategy:
          fail-fast: false
          matrix:
            dir: [ 'avx2' , 'ref']
        steps:
        - uses: actions/checkout@v4
          with:
            submodules: recursive
        - uses: cachix/install-nix-action@v31
          with:
            nix_path: nixpkgs=channel:nixos-unstable
        - run: nix-shell --arg full false --run "make -C submodules/XKCP/ x86-64/libXKCP.so"
        - run: nix-shell --arg full false --run "echo Dependencies OKâ€¦"
        - run: nix-shell --arg full false --run "make -C src/amd64/${{matrix.dir}}/ test"
    